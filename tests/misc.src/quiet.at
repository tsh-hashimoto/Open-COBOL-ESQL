AT_SETUP([quiet option test])

AT_DATA([prog1.cbl], [
        IDENTIFICATION      DIVISION.
        PROGRAM-ID.         prog.
        DATA                DIVISION.
        WORKING-STORAGE     SECTION.
        01 TEST-CASE-COUNT  PIC 9999 VALUE 1.

        EXEC SQL BEGIN DECLARE SECTION END-EXEC.
        01  DBNAME PIC X(30) VALUE SPACE.
        01  USERNAME  PIC X(30) VALUE SPACE.
        01  PASSWD  PIC X(30) VALUE SPACE.
        EXEC SQL END DECLARE SECTION END-EXEC.

        EXEC SQL INCLUDE SQLCA END-EXEC.

        PROCEDURE           DIVISION.
        MAIN-RTN.

            MOVE  "<|DB_NAME|>@<|DB_HOST|>:<|DB_PORT|>"
              TO DBNAME.
            MOVE  "<|DB_USER|>"
              TO USERNAME.
            MOVE  "<|DB_PASSWORD|>"
              TO PASSWD.
        
            EXEC SQL
              CONNECT :USERNAME IDENTIFIED BY :PASSWD USING :DBNAME
            END-EXEC.

            EXEC SQL
                DISCONNECT ALL
            END-EXEC.

            STOP RUN.
])

AT_CHECK([printf "precompile start: prog1.cbl\n=======================================================\n              LIST OF CALLED DB Library API            \n=======================================================\nGenerate:OCESQLConnect\nGenerate:OCESQLDisconnect\n=======================================================\n" > expected_output.txt])
AT_CHECK([ocesql prog1.cbl prog1.cob > output.txt], [0])
AT_CHECK([diff expected_output.txt output.txt], [0])

AT_CHECK([ocesql -q prog1.cbl prog1.cob], [0])
AT_CHECK([ocesql --quiet prog1.cbl prog1.cob], [0])

AT_DATA([prog2.cbl], [
        IDENTIFICATION      DIVISION.
        PROGRAM-ID.         prog.
        DATA                DIVISION.
        WORKING-STORAGE     SECTION.
        PROCEDURE           DIVISION.
        MAIN-RTN.
            DISPLAY "HELLO, WORLD".
            STOP RUN.
])

AT_CHECK([ocesql prog2.cbl prog2.cob > /dev/null], [0])
AT_CHECK([ocesql -q prog2.cbl prog2.cob], [0])
AT_CHECK([diff prog2.cbl prog2.cob], [0])
AT_CHECK([ocesql --quiet prog2.cbl prog2.cob], [0])
AT_CHECK([diff prog2.cbl prog2.cob], [0])

AT_DATA([prog3.cbl], [
        IDENTIFICATION      DIVISION.
        PROGRAM-ID.         prog.
        DATA                DIVISION.
        WORKING-STORAGE     SECTION.
        01 TEST-CASE-COUNT  PIC 9999 VALUE 1.

        EXEC SQL BEGIN DECLARE SECTION END-EXEC.
        01  DBNAME PIC X(30) VALUE SPACE.
        01  USERNAME  PIC X(30) VALUE SPACE.
        01  PASSWD  PIC X(30) VALUE SPACE.
        EXEC SQL END DECLARE SECTION END-EXEC.

        EXEC SQL INCLUDE SQLCA END-EXEC.

        PROCEDURE           DIVISION.
        MAIN-RTN.

            MOVE  "<|DB_NAME|>@<|DB_HOST|>:<|DB_PORT|>"
              TO DBNAME.
            MOVE  "<|DB_USER|>"
              TO USERNAME.
            MOVE  "<|DB_PASSWORD|>"
              TO PASSWD.
        
            EXEC SQL
                    CONNECT :USERNAME IDENTIFIED BY :PASSWD USING :DBNAME
            END-EXEC.

            EXEC SQL
                DISCONNECT ALL
            END-EXEC.

            STOP RUN.
])

AT_CHECK([ocesql prog3.cbl prog3.cob | grep "translate error" > /dev/null], [0])
AT_CHECK([ocesql -q prog3.cbl prog3.cob | grep "translate error" > /dev/null], [0])
AT_CHECK([ocesql --quiet prog3.cbl prog3.cob | grep "translate error" > /dev/null], [0])

AT_CLEANUP
